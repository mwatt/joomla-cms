<?php

class JInstallerStandaloneProviderAkeeba extends JInstallerStandaloneProvider {

  /**
   * [reset description]
   * @return [type] [description]
   */
  public function reset(){

    // Delete Previous Files
      $installer_path = $this->get('installer_path');
      if( is_readable($installer_path . 'debug.txt') ){
        @unlink($installer_path . 'debug.txt');
      }

  }

  /**
   * [buildInstaller description]
   * @return [type] [description]
   */
  public function buildInstaller(){

    // Stage
      $app            = JFactory::getApplication();
      $package        = $this->get('package');
      $installer_path = $this->get('installer_path');
      $installer_file = $this->get('installer_file');
      $installer_site = $this->get('installer_site');

    // Create / Store Password
      $password = JUserHelper::genRandomPassword(32);
      $app->setUserState('com_installer.installer.password', $password);

    // Identify File Location / Size
      $filesize = $this->__foldersize($package['dir']);
      $app->setUserState('com_installer.installer.filesize', $filesize);

    // Prepare
      $callUrl   = JFactory::getApplication()->getUserState('com_installer.installer.callurl', null);
      $returnUrl = JFactory::getApplication()->getUserState('com_installer.installer.returnurl', null);

    // JS COnfig for Monitor
      JFactory::getDocument()->addScriptDeclaration("
      var com_installer_password = '$password';
      var com_installer_totalsize = '$filesize';
      var com_installer_ajax_url = '$callUrl';
      var com_installer_return_url = '$returnUrl';
      jQuery(document).ready(function(){ window.pingExtract(); });
      ");

    // Load scripts for Monitor
      JHtml::_('jquery.framework');
      JFactory::getDocument()->addScript(JUri::root(true) . '/media/com_installer/akeeba/js/json2.js', false, true, false);
      JFactory::getDocument()->addScript(JUri::root(true) . '/media/com_installer/akeeba/js/encryption.js', false, true, false);
      JFactory::getDocument()->addScript(JUri::root(true) . '/media/com_installer/akeeba/js/update.js', false, true, false);

    // Build list
      $targetPathRegex = trim(str_replace('/', '.', $installer_site), '.');
      $installerBuildList = array(
        array(
          "",
          "/*",
          "  Generated by " . __FILE__,
          "  " . gmdate('Y-m-d H:i:s'),
          "*/",
          "",
          "if( !preg_match('/{$targetPathRegex}/', __DIR__) ){ exit; }",
          ""
          ),
        $this->createInstallerConfig(),
        __DIR__ . '/akeeba/installer.php'
        /*
        __DIR__ . '/akeeba/installer_parts/init.php',
        __DIR__ . '/akeeba/installer_parts/functions.php',
        __DIR__ . '/akeeba/installer_parts/json.php',
        __DIR__ . '/akeeba/installer_parts/abstractObject.php',
        __DIR__ . '/akeeba/installer_parts/abstractPart.php',
        __DIR__ . '/akeeba/installer_parts/abstractUnarchiver.php',
        __DIR__ . '/akeeba/installer_parts/abstractPostproc.php',
        __DIR__ . '/akeeba/installer_parts/abstractPartObserver.php',
        __DIR__ . '/akeeba/installer_parts/postProdDirect.php',
        __DIR__ . '/akeeba/installer_parts/postProcFtp.php',
        __DIR__ . '/akeeba/installer_parts/postProcSftp.php',
        __DIR__ . '/akeeba/installer_parts/postProcHybrid.php',
        __DIR__ . '/akeeba/installer_parts/unarchiverJpa.php',
        __DIR__ . '/akeeba/installer_parts/unarchiverZip.php',
        __DIR__ . '/akeeba/installer_parts/unarchiverJps.php',
        __DIR__ . '/akeeba/installer_parts/unarchiverFolder.php',
        __DIR__ . '/akeeba/installer_parts/coreTimer.php',
        __DIR__ . '/akeeba/installer_parts/utilsListener.php',
        __DIR__ . '/akeeba/installer_parts/text.php',
        __DIR__ . '/akeeba/installer_parts/factory.php',
        __DIR__ . '/akeeba/installer_parts/encryotionAes.php',
        __DIR__ . '/akeeba/installer_parts/master.php',
        __DIR__ . '/akeeba/installer_parts/controller.php'
        */
        );

    // Build installer file
      $fh = fopen( $installer_path . $installer_file, 'w+' );
      if( $fh ){
        $bytesWritten = 0;
        foreach( $installerBuildList AS $item ){
          if( !$bytesWritten ){
            $tmpBuffer = '<?php';
            fwrite( $fh, $tmpBuffer );
            $bytesWritten += strlen( $tmpBuffer );
          }
          if( is_array($item) ){
            fwrite( $fh, "\n\n");
            fwrite( $fh, "/*\n  Code Block \n*/");
            fwrite( $fh, "\n\n");
            fwrite( $fh, implode("\n", $item) );
          }
          else if( is_string($item) && is_readable($item) ){
            $fa = fopen( $item, 'r' );
            if( $fa ){
              fwrite( $fh, "\n\n");
              fwrite( $fh, "/*\n  Source\n  ".$item.' / '.filesize($item)."\n*/");
              fwrite( $fh, "\n\n");
              $bytesRead = 0;
              while( !feof($fa) && $buffer = fread($fa, 1024 * 10) ){
                if( $bytesRead == 0 && preg_match('/^\<\?(php|)[\s\r\n]+/',$buffer) ){
                  $bytesRead += strlen( $buffer );
                  $tmpBuffer = preg_replace('/^\<\?(php|)[\s\r\n]+/', '', $buffer);
                  $bytesWritten += strlen( $tmpBuffer );
                  $buffer = $tmpBuffer;
                }
                else {
                  $bytesRead += strlen( $buffer );
                  $bytesWritten += strlen( $buffer );
                }
                fwrite( $fh, $buffer );
              }
              fclose( $fa );
            }
            else {
              $app->enqueueMessage(JText::_('COM_INSTALLER_STANDALONE_BUILD_FAILED'), 'error');
              return false;
            }
          }
        }
        fclose( $fh );
      }
      else {
        $app->enqueueMessage(JText::_('COM_INSTALLER_STANDALONE_NOT_WRITABLE'), 'error');
        return false;
      }
      if( !is_readable($installer_path . $installer_file) ){
        $app->enqueueMessage(JText::_('COM_INSTALLER_STANDALONE_NOT_WRITABLE'), 'error');
        return false;
      }

    // Success
      return true;

  }

  /**
   * [createInstallerConfig description]
   * @return [type] [description]
   */
  private function createInstallerConfig()
  {

    // Stage
      $app        = JFactory::getApplication();
      $config     = JFactory::getConfig();
      $method     = $app->input->get('method', 'direct');
      $package    = $this->get('package');
      $params     = $this->get('params');
      $siteroot   = JPATH_SITE;
      $dryrun     = 0;
      $tempdir    = $config->get('tmp_path');
      $password   = $app->getUserState('com_installer.installer.password');

    // Identify Filetype
      $file = $package['dir'];
      $filetype = is_dir($file) ? 'folder' : 'file';

    // Start Output Generation
      $config_output = array();
      $config_output[] = "\$restoration_setup = array(";

    // Start Config Generation
      $config_output_config = array();
      $config_output_config[] ="'kickstart.security.password' => '$password'";
      $config_output_config[] ="'kickstart.tuning.max_exec_time' => '5'";
      $config_output_config[] ="'kickstart.tuning.run_time_bias' => '75'";
      $config_output_config[] ="'kickstart.tuning.min_exec_time' => '0'";
      $config_output_config[] ="'kickstart.procengine' => '$method'";
      $config_output_config[] ="'kickstart.setup.sourcefile' => '$file'";
      $config_output_config[] ="'kickstart.setup.destdir' => '$siteroot'";
      $config_output_config[] ="'kickstart.setup.restoreperms' => '0'";
      $config_output_config[] ="'kickstart.setup.filetype' => '$filetype'";
      $config_output_config[] ="'kickstart.setup.dryrun' => '$dryrun'";

    // Push FTP Environment (do a lot of folder validation)
      if( $method == 'ftp' ){

        /*
         * Fetch the FTP parameters from the request. Note: The password should be
         * allowed as raw mode, otherwise something like !@<sdf34>43H% would be
         * sanitised to !@43H% which is just plain wrong.
         */
          $ftp_host = $app->input->get('ftp_host', '');
          $ftp_port = $app->input->get('ftp_port', '21');
          $ftp_user = $app->input->get('ftp_user', '');
          $ftp_pass = $app->input->get('ftp_pass', '', 'default', 'none', 2);
          $ftp_root = $app->input->get('ftp_root', '');

        /**
         * Below validates the availability of a remote tmp folder for writing
         */

        // Is the tempdir really writable?
          $writable = @is_writeable($tempdir);
          if ($writable) {
            // Let's be REALLY sure.
            $fp = @fopen($tempdir . '/test.txt', 'w');
            if ($fp === false) {
              $writable = false;
            }
            else {
              fclose($fp);
              unlink($tempdir . '/test.txt');
            }
          }

        // If the tempdir is not writable, create a new writable subdirectory.
          if (!$writable) {
            $FTPOptions = JClientHelper::getCredentials('ftp');
            $ftp = JClientFtp::getInstance($FTPOptions['host'], $FTPOptions['port'], null, $FTPOptions['user'], $FTPOptions['pass']);
            $dest = JPath::clean(str_replace(JPATH_ROOT, $FTPOptions['root'], $tempdir . '/admintools'), '/');
            if (!@mkdir($tempdir . '/admintools')){
              $ftp->mkdir($dest);
            }
            if (!@chmod($tempdir . '/admintools', 511)){
              $ftp->chmod($dest, 511);
            }
            $tempdir .= '/admintools';
          }

        // Just in case the temp-directory was off-root, try using the default tmp directory.
          $writable = @is_writeable($tempdir);
          if (!$writable) {
            $tempdir = JPATH_ROOT . '/tmp';
            // Does the JPATH_ROOT/tmp directory exist?
            if (!is_dir($tempdir)) {
              JFolder::create($tempdir, 511);
              JFile::write($tempdir . '/.htaccess', "order deny,allow\ndeny from all\nallow from none\n");
            }
            // If it exists and it is unwritable, try creating a writable admintools subdirectory.
            if (!is_writable($tempdir)) {
              $FTPOptions = JClientHelper::getCredentials('ftp');
              $ftp = JClientFtp::getInstance($FTPOptions['host'], $FTPOptions['port'], null, $FTPOptions['user'], $FTPOptions['pass']);
              $dest = JPath::clean(str_replace(JPATH_ROOT, $FTPOptions['root'], $tempdir . '/admintools'), '/');
              if (!@mkdir($tempdir . '/admintools')) {
                $ftp->mkdir($dest);
              }
              if (!@chmod($tempdir . '/admintools', 511)) {
                $ftp->chmod($dest, 511);
              }
              $tempdir .= '/admintools';
            }
          }

        // If we still have no writable directory, we'll try /tmp and the system's temp-directory.
          $writable = @is_writeable($tempdir);
          if (!$writable) {
            if (@is_dir('/tmp') && @is_writable('/tmp')) {
              $tempdir = '/tmp';
            }
            else {
              // Try to find the system temp path.
              $tmpfile = @tempnam("dummy", "");
              $systemp = @dirname($tmpfile);
              @unlink($tmpfile);
              if (!empty($systemp)) {
                if (@is_dir($systemp) && @is_writable($systemp)) {
                  $tempdir = $systemp;
                }
              }
            }
          }

        // Did we Succeed?
          if( !empty($tempdir) ){
            $config_output_config[] = "'kickstart.ftp.ssl' => '0'";
            $config_output_config[] = "'kickstart.ftp.passive' => '1'";
            $config_output_config[] = "'kickstart.ftp.host' => '$ftp_host'";
            $config_output_config[] = "'kickstart.ftp.port' => '$ftp_port'";
            $config_output_config[] = "'kickstart.ftp.user' => '$ftp_user'";
            $config_output_config[] = "'kickstart.ftp.pass' => '$ftp_pass'";
            $config_output_config[] = "'kickstart.ftp.dir' => '$ftp_root'";
            $config_output_config[] = "'kickstart.ftp.tempdir' => '$tempdir'";
          }

      }

    // Append Config Options to Output;
      if( $config_output_config ){
        $config_output[] = implode(",\n", $config_output_config);
      }
      $config_output[] = ');';

    // Return
      return $config_output;

  }

  protected function __foldersize( $base, $path=null ){
    $size = 0;
    $files = scandir( $base.'/'.$path );
    foreach( $files AS $file ){
      if( !preg_match('/^\.+$/', $file) ){
        if( is_dir($base.'/'.$path.$file) ){
          $size += $this->__foldersize($base, $path.$file.'/');
        }
        else if( is_readable($base.'/'.$path.$file) ){
          $size += filesize($base.'/'.$path.$file);
        }
      }
    }
    return $size;
  }

}